import streamlit as st
import pandas as pd
import plotly.express as px

# ---------------------------------------------------------
# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏•‡∏∞‡∏ü‡∏≠‡∏ô‡∏ï‡πå (‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÅ‡∏û‡∏á)
# ---------------------------------------------------------
st.set_page_config(page_title="Inventory Dashboard", layout="wide")

# CSS hack ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÄ‡∏õ‡πá‡∏ô 'Kanit' ‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏ß‡πá‡∏ö
st.markdown("""
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap');
        html, body, [class*="css"]  {
            font-family: 'Kanit', sans-serif;
        }
    </style>
    """, unsafe_allow_html=True)

# ---------------------------------------------------------
# 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet
# ---------------------------------------------------------
# üëáüëá ‡πÄ‡∏≠‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå CSV ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î)
sheet_url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ75RDJdohY6N12_oX9IVC48zBLT3nU4Ym_VJXaaalYcGY9wlSyyXvBOJCfRkzxvVh8BCgCwbnFZc7G/pub?output=csv"

@st.cache_data(ttl=60) # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏à‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏•‡∏≠‡∏î
def load_data():
    try:
        data = pd.read_csv(sheet_url)
        return data
    except Exception as e:
        st.error(f"‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: {e}")
        return None

df = load_data()

# ---------------------------------------------------------
# 3. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Dashboard
# ---------------------------------------------------------
if df is not None:
    st.title("üì¶‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏†‡∏≤‡∏ú‡∏π‡πâ‡πÅ‡∏ó‡∏ô‡∏£‡∏≤‡∏©‡∏é‡∏£ ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏ï‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢")
    st.markdown("---")

    # ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÉ‡∏ô Sheet ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ä‡∏∑‡πà‡∏≠ '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'
    # (‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô Excel ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏£‡∏¥‡∏á‡πÜ)
    
    # --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (Metrics) ---
    col1, col2, col3 = st.columns(3)
    
    # ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    total_items = len(df)
    col1.metric("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", f"{total_items} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "Update ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î")

    # ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'
    if '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' in df.columns:
        total_qty = df['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'].sum()
        col2.metric("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏°", f"{total_qty} ‡∏ä‡∏¥‡πâ‡∏ô")

    # --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á ---
    c1, c2 = st.columns([2, 1]) # ‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡∏ã‡πâ‡∏≤‡∏¢‡∏Å‡∏ß‡πâ‡∏≤‡∏á 2 ‡∏™‡πà‡∏ß‡∏ô ‡∏Ç‡∏ß‡∏≤ 1 ‡∏™‡πà‡∏ß‡∏ô

    with c1:
        st.subheader("üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")
        # ‡πÇ‡∏ä‡∏ß‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡∏ß‡∏¢‡πÜ
        st.dataframe(df, use_container_width=True, hide_index=True)

    with c2:
        st.subheader("üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞")
        # ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' (‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡∏Ç‡∏≠‡∏á, ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î)
        if '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' in df.columns:
            status_count = df['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'].value_counts().reset_index()
            status_count.columns = ['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']
            
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏° (Donut Chart)
            fig = px.donut(status_count, values='‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', names='‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', 
                           hole=0.4, color_discrete_sequence=px.colors.qualitative.Pastel)
            st.plotly_chart(fig, use_container_width=True)
        else:
            st.info("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel")

else:
    st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå Google Sheet CSV ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î")